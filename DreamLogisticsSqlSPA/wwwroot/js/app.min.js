var myApp=angular.module("myApp",["ngRoute","myControllers"]),myControllers;myApp.config(["$routeProvider","$locationProvider","$httpProvider",function(n,t,i){t.hashPrefix("");n.when("/login",{templateUrl:"/app/partials/login.html",controller:"LoginController"}).when("/queryList",{templateUrl:"/app/partials/queryList.html",controller:"QueryListController"}).when("/search/:queryId",{templateUrl:"/app/partials/search.html",controller:"SearchController"}).when("/result",{templateUrl:"/app/partials/result.html",controller:"ResultController"}).when("/create",{templateUrl:"/app/partials/createAndEditQuery.html",controller:"CreateEditController"}).when("/edit/:queryId",{templateUrl:"/app/partials/createAndEditQuery.html",controller:"CreateEditController"}).otherwise({redirectTo:"/queryList"});i.interceptors.push("BearerAuthInterceptor")}]).run(["$rootScope","$location","$window","utilitiesService",function(n,t,i,r){n.$on("$routeChangeStart",function(){var t=i.localStorage.getItem("token"),u;t===null||typeof t=="undefined"||t===""?location.hash.indexOf("login")===-1&&(i.location.href="/#/login"):(u=r.getUserInfo(t),i.localStorage.setItem("name",u.unique_name),i.localStorage.setItem("roleId",u.role),n.user={roleId:i.localStorage.getItem("roleId"),name:i.localStorage.getItem("name")},i.location.href="#/queryList")})}]);myControllers=angular.module("myControllers",[]);myControllers.controller("CreateEditController",["$scope","$http","$routeParams","$rootScope","$window","$document",function(n,t,i,r,u,f){function o(n){(n.keyCode==27||n.which==27||n.key=="Escape")&&(u.location.href="#/queryList")}function s(){if(e==!1){const n=document.getElementById("text");n.style.display="none";e=!0}}f.on("keyup",o);n.$on("$destroy",function(){f.off("keyup",o)});r.user.roleId!="4"&&(u.location.href="#/queryList");n.queryEdited=!1;n.create=!1;n.deletedQueryParams=[];i.queryId===undefined?(n.create=!0,n.queryData={groupName:"",sql:""},n.queryData.queryParams=[{name:"",typeId:1,parameterCode:"",tableName:"",displayColumn:"",keyColumn:"",paramOptional:""}],n.title="Skapa Rapportmall"):t.get("https://localhost:44313/api/query/NoList/"+i.queryId).then(function(t){n.queryData=t.data;n.title="Redigera Rapportmall"});n.addOptions=function(t){const i=document.getElementsByClassName("sql-options-"+t);if(n.queryData.queryParams[t].typeId=="4")for(const n of i)n.style.display="block";else{for(const n of i)n.style.display="none";n.queryData.queryParams[t].tableName="";n.queryData.queryParams[t].displayColumn="";n.queryData.queryParams[t].keyColumn=""}};n.addRow=function(){n.queryData.queryParams.push({name:"",typeId:1,parameterCode:"",tableName:"",displayColumn:"",keyColumn:"",paramRequired:""})};n.removeRow=function(t){var i=n.queryData.queryParams[t].id;i!=undefined&&n.deletedQueryParams.push(i);n.queryData.queryParams.splice(t,1)};var e=!0;window.addEventListener("click",s);n.testSqlValues=function(i){var r={tableName:i.tableName,displayColumn:i.displayColumn,keyColumn:i.keyColumn};t.post("https://localhost:44313/api/query/SqlList",r).then(function(t){n.sqlList=t.data});const u=document.getElementById("text");u.style.display="block"};n.setBoolFalse=function(){e=!1};n.setBoolTrue=function(){e=!0};n.modalBoxEnter=function(){e=!0};n.modalBoxLeave=function(){e=!1};n.close=function(){const n=document.getElementById("text");n.style.display="none";e=!0};n.submitQuery=function(){n.create?createQuery():n.create||editQuery()};editQuery=function(){n.completeMessage="Rapportmall Uppdaterad!";angular.forEach(n.queryData.queryParams,function(n){n.typeId=parseInt(n.typeId)});n.queryData.queryParamsToDelete=n.deletedQueryParams;t({method:"PUT",url:"https://localhost:44313/api/query/UpdateQuery",data:n.queryData});n.queryEdited=!0};createQuery=function(){n.completeMessage="Rapportmall Skapad!";angular.forEach(n.queryData.queryParams,function(n){n.typeId=parseInt(n.typeId);n.paramOptional=n.paramOptional==0?!1:!0});t({method:"POST",url:"https://localhost:44313/api/query/Create",data:n.queryData});n.queryEdited=!0}}]);myControllers.controller("LayOutController",["$scope","$http","$window","$rootScope",function(n,t,i,r){n.logOut=function(){i.localStorage.removeItem("token");r.user.name="";i.location.href="#/login"};n.homeBtn=function(){i.localStorage.getItem("token")&&(i.location.href="#/queryList")}}]);myControllers.controller("LoginController",["$scope","$http","$window","$document",function(n,t,i,r){function u(t){(t.keyCode==13||t.which==13||t.key=="Enter")&&n.loginAttempt()}n.login={username:"",password:""};r.on("keyup",u);n.$on("$destroy",function(){r.off("keyup",u)});n.loginAttempt=function(){t.post("https://localhost:44313/api/Login/",n.login).then(function(t){var r=t.data;r!=""?(i.localStorage.setItem("token",r),i.location.href="/#/queryList"):n.invalidUser="Felaktiga Inloggninsuppgifter"},function(n){console.log("error");console.log(n)})}}]);myControllers.controller("QueryListController",["$scope","$http","$window","$rootScope",function(n,t,i,r){function u(n){var t,i;if(n.keyCode==27||n.which==27||n.key=="Escape"){const n=document.getElementsByClassName("details-drop-down-section"),r=document.getElementsByClassName("delete-drop-down-section");for(t of r)t.style.display="none";for(i of n)i.style.display="none"}}window.addEventListener("keydown",u);n.isAdmin=!1;r.user.roleId==="4"&&(n.isAdmin=!0,t.get("https://localhost:44313/api/query/QueryParams").then(function(t){n.query=t.data}));t.get("https://localhost:44313/api/query").then(function(t){n.isAuthorized=!0;n.queries=t.data;n.queries==0&&(n.noQueriesMessage="Det finns inga rapportmallar att välja på")});n.details=function(n){const t=document.getElementById("details-option-"+n);t.style.display=t.style.display=="table-row"?"none":"table-row"};n.delete=function(n){const t=document.getElementById("delete-option-"+n);t.style.display=t.style.display=="table-row"?"none":"table-row"};n.closeAll=function(n){const t=document.getElementById("delete-option-"+n),i=document.getElementById("details-option-"+n);t.style.display="none";i.style.display="none"};n.deleteConfirmed=function(n){t.delete("https://localhost:44313/api/query/DeleteQuery/"+n);const i=document.getElementById("delete-option-"+n),r=document.getElementById("query-row-"+n),u=document.getElementById("details-option-"+n),f=document.getElementById("delete-message-top"),e=document.getElementById("delete-confirmed-"+n);r.style.display="none";u.style.display="none";i.style.display="none";e.style.display="table-row";f.style.display="block"};n.closeDeleteConfirmed=function(n){const t=document.getElementById("delete-confirmed-"+n),i=document.getElementById("delete-message-top");t.style.display="none";i.style.display="none"}}]);myControllers.controller("SearchController",["$scope","$http","$routeParams","utilitiesService","$window","$document",function(n,t,i,r,u,f){function e(n){(n.keyCode==27||n.which==27||n.key=="Escape")&&(u.location.href="#/queryList")}function o(){var t;return n.validInputs=!0,t={QueryId:n.searchInfo.query.id,Parameters:[]},angular.forEach(n.searchInfo.queryParams,function(i){if(i.typeId==2){i.value=r.formatDate(i.value);/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(i.value)||(n.dateInputMessage="Ogiltligt Datum",n.validInputs=!1)}i.value!=null?t.Parameters.push({Id:i.id,Value:i.value.toString()}):t.Parameters.push({Id:i.id,Value:null})}),{valid:n.validInputs,payload:t}}n.searchCompleted=!1;n.invalidQueryParam=!1;f.on("keyup",e);n.$on("$destroy",function(){f.off("keyup",e)});t.get("https://localhost:44313/api/query/List/"+i.queryId).then(function(t){for(var i of t.data.queryParams)i.typeId==4&&(i.sqlLists.length==0?n.invalidQueryParam=!0:(console.log(i.sqlLists),i.sqlLists.unshift({displayColumn:"(ej satt)",keyColumn:null})));n.searchInfo=t.data});n.searchQueryExcel=function(){var i=o();i.valid&&t.post("https://localhost:44313/api/Search/Excel",i.payload,{responseType:"blob"}).then(function(t){var u=new Blob([t.data],{type:"application/octet-stream"});if(u.size!=0){n.noResult="";var f=URL.createObjectURL(u),e=r.formatFileName(n.searchInfo.query.groupName),i=document.createElement("a");i.href=f;i.target="_blank";i.download=e;document.body.appendChild(i);i.click();document.body.removeChild(i)}else n.noResult="Inga resultat med den sökningen"},function(n){console.log("error");console.log(n)})};n.searchQuery=function(){var i=o();i.valid&&t.post("https://localhost:44313/api/Search",i.payload).then(function(t){n.searchResult=t.data;n.searchCompleted=!0;n.searchResult.columnNames.length==0?n.noResultView="Felaktiga parametrar i Rapportmallen, Kontakta IT":n.searchResult.rowValues.length==0&&(n.noResultView="Inga resultat med den sökningen")},function(n){console.log("error");console.log(n)})};n.searchAgain=function(){n.searchCompleted=!1}}]),function(){"use strict";angular.module("myApp").factory("utilitiesService",["$http","$q",function(){var n={};return n.getUserInfo=function(t){var i=/\.(.*?)\./g.exec(t),r=n.urlBase64Decode(i[1]);return JSON.parse(r)},n.urlBase64Decode=function(n){var t=n.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string";}return decodeURIComponent(window.escape(window.atob(t)))},n.formatDate=function(n){var r=new Date(n),t=""+(r.getMonth()+1),i=""+r.getDate(),u=r.getFullYear();return t.length<2&&(t="0"+t),i.length<2&&(i="0"+i),[u,t,i].join("-")},n.formatFileName=function(n){var i=n.replace(/ /g,"_"),t=new Date,r=t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2),u=("0"+t.getHours()).slice(-2)+"_"+("0"+t.getMinutes()).slice(-2)+"_"+("0"+t.getSeconds()).slice(-2),f=r+" "+u;return i+" "+f+".xlsx"},n}])}();myApp.factory("BearerAuthInterceptor",["$window","$q","$rootScope",function(n,t,i){return{request:function(i){return i.headers=i.headers||{},n.localStorage.getItem("token")&&(i.headers.Authorization="Bearer "+n.localStorage.getItem("token")),i||t.when(i)},responseError:function(t){t.status===401&&n.localStorage.getItem("token")!=""?(n.localStorage.removeItem("token"),i.user.name="",n.location.href="#/login"):t.status===401?n.location.href="#/login":t.status===404&&(n.location.href="/#/queryList")},response:function(n){return n||t.when(n)}}}]);